$("._tab").click(function() {
    let parentBlock = $(this).parents("._tabs-parent")
    let tabId = $(this).attr("data-tab")
    $(parentBlock).find("._tab").removeClass("_active")
    $(this).addClass("_active")
    $(parentBlock).find(".tab-content").removeClass("_active")
    $(parentBlock).find(`.${tabId}`).addClass("_active")
})

$(".qa-card__show").click(function() {
    $(this).parents(".qa-card").toggleClass("_active")
    $(this).siblings(".qa-card__hidden").slideToggle()
})

$(".house-about__more").click(function () {
    $(this).parents(".house-about").toggleClass("_show-text")
})

if (document.querySelector('#video')) {
    let video = document.querySelector('#video');

    video.addEventListener('click',function(){
        video.play();
    },false);
    video.click();
    video.play();
}

$("._show-all-process").click(function () {
    $(this).parents(".tab-content").toggleClass("_show-all")
})

// $(document).mouseup( function(e){
//     let div = $( ".header-action__item--cart" );
//     if ( !div.is(e.target)
//         && div.has(e.target).length === 0 ) {
//         if($(div).hasClass("_open")){
//             $(div).removeClass("_open")
//         }
//     }
// });

$(".burger").click(function () {
    $(".header").toggleClass("_open")
    $("body").toggleClass("fixed-body")
})


function Sliders() {
    let SlidersArray = []

    let sliders = document.querySelectorAll(".slider")
    sliders.forEach((slider,index) => {
        slider.setAttribute("data-slider-id",index)

        SlidersArray[index] = new Swiper(`.slider[data-slider-id="${index}"] .swiper-container`, {
            slidesPerView: "auto",
            spaceBetween: 0,
            watchSlidesProgress: true,
            preventClicks :true,
            a11y: false,
            observer: true,
            observeParents: true,
            observeSlideChildren: true,

            navigation: {
                nextEl: `.slider[data-slider-id="${index}"] .swiper-button-next`,
                prevEl: `.slider[data-slider-id="${index}"] .swiper-button-prev`,
            },
            pagination: {
                el: `.slider[data-slider-id="${index}"] .swiper-pagination`,
                type: 'bullets',
                clickable: true,
            },
        })
    })
}

function gallery() {
    let SlidersArray = []

    let sliders = document.querySelectorAll(".gallery")
    sliders.forEach((slider,index) => {
        slider.setAttribute("data-slider-id",index)
        let gallery = {
            mySwiper: {},
            mySwiper2: {}
        }

        gallery.mySwiper = new Swiper(`.gallery[data-slider-id="${index}"] .mySwiper`, {
            spaceBetween: 0,
            slidesPerView: "auto",
            freeMode: true,
            watchSlidesProgress: true,
            direction: "vertical",
            breakpoints: {
                320: {
                    direction: "horizontal",
                },
                992: {
                    direction: "vertical",
                }
            }
        });
        gallery.mySwiper2 = new Swiper(`.gallery[data-slider-id="${index}"] .mySwiper2`, {
            spaceBetween: 0,
            direction: "vertical",
            loop: true,
            navigation: {
                nextEl: `.gallery[data-slider-id="${index}"] .swiper-button-next`,
                prevEl: `.gallery[data-slider-id="${index}"] .swiper-button-prev`,
            },
            thumbs: {
                swiper:  gallery.mySwiper,
            },
            breakpoints: {
                320: {
                    direction: "horizontal",
                },
                992: {
                    direction: "vertical",
                }
            }
        });

        SlidersArray[index] = gallery
    })

}


Sliders()
gallery()

const mortgageYearsSlider = document.getElementById('mortgage-years');
const mortgageYearsInput  = document.getElementById('mortgage-years-output');

function createSlider(slider){
    noUiSlider.create(slider, {
        start: +slider.getAttribute("data-current"),
        connect: [true, false],
        range: {
            min: +slider.getAttribute("data-min"),
            max: +slider.getAttribute("data-max")
        },
        step: 1
    });
}

if(mortgageYearsSlider){
    createSlider(mortgageYearsSlider)
    mortgageYearsSlider.noUiSlider.on('update', (values) => {
        mortgageYearsInput.value = Math.round(values[0]);
    });

    mortgageYearsInput.addEventListener('change', () => {
        mortgageYearsSlider.noUiSlider.set(mortgageYearsInput.value);
    });
}


const mortgagePriceSlider = document.getElementById('mortgage-price');
const mortgagePriceInput  = document.getElementById('mortgage-price-output');

if(mortgagePriceSlider){
    createSlider(mortgagePriceSlider)

    mortgagePriceSlider.noUiSlider.on('update', (values) => {
        const value = Math.round(values[0]);
        mortgagePriceInput.value = formatNumber(value);
    });

    mortgagePriceInput.addEventListener('change', () => {
        const raw = parseNumber(mortgagePriceInput.value);
        mortgagePriceInput.value = formatNumber(raw);
        mortgagePriceSlider.noUiSlider.set(raw);
    });
}

const mortgageRangeSlider = document.getElementById('mortgage-range');
const mortgageRangeInput  = document.getElementById('mortgage-range-output');
const mortgageRangeMin  = document.getElementById('mortgage-range-min');
const mortgageRangeMax  = document.getElementById('mortgage-range-max');

if(mortgageRangeSlider){
    noUiSlider.create(mortgageRangeSlider, {
        start: [
            +mortgageRangeSlider.getAttribute("data-current"),
            +mortgageRangeSlider.getAttribute("data-current2"),
        ],
        connect: true,
        range: {
            min: +mortgageRangeSlider.getAttribute("data-min"),
            max: +mortgageRangeSlider.getAttribute("data-max")
        },
        step: 1
    });

    mortgageRangeSlider.noUiSlider.on('update', (values) => {
        const from = Math.round(values[0]);
        const to   = Math.round(values[1]);

        mortgageRangeMin.value = from
        mortgageRangeMax.value = to

        mortgageRangeInput.value = `${formatNumber(from)} - ${formatNumber(to)}`
    });
}




function formatNumber(value) {
    return value
        .toString()
        .replace(/\D/g, '')                 // только цифры
        .replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
}

function parseNumber(formatted) {
    return Number(formatted.replace(/\s/g, ''));
}

// Программы для сравнения (ставки в % годовых)
let calc = document.querySelector(".m-calc")

const PROGRAMS = [
    { id:'dv',     name:'Дальневосточная и Арктическая ипотека', rate: 2.0 },
    { id:'family', name:'Семейная ипотека',                     rate: 6.0 },
    { id:'it',     name:'Ипотека для IT',                       rate: 5.0 },
    { id:'rural',  name:'Сельская ипотека',                     rate: 3.0 }
];

const priceEl = document.getElementById('price');
const dpEl    = document.getElementById('dp');
const yearsEl = document.getElementById('years');

const kLoan   = document.getElementById('kLoan');
const kDP     = document.getElementById('kDP');
const kMonths = document.getElementById('kMonths');

const tbody   = document.getElementById('tbody');
const tableHint = document.getElementById('tableHint');

const applyBtn = document.getElementById('applyBtn');
const resetBtn = document.getElementById('resetBtn');

function sanitizeNumber(v){
    if (v === null || v === undefined) return NaN;
    const s = String(v).replace(/\s+/g,'').replace(/руб\.?|₽/gi,'').replace(',', '.');
    const n = Number(s);
    return Number.isFinite(n) ? n : NaN;
}

function money(v){
    if (!Number.isFinite(v)) return '—';
    return Math.round(v).toLocaleString('ru-RU') + ' ₽';
}

function percent(v){
    if (!Number.isFinite(v)) return '—';
    return v.toLocaleString('ru-RU') + '%';
}

// Аннуитетный платёж
function annuity(L, annualRatePct, months){
    const i = (annualRatePct / 100) / 12;
    if (months <= 0) return NaN;
    if (i === 0) return L / months;
    return L * i / (1 - Math.pow(1 + i, -months));
}

// форматирование суммы с сохранением позиции курсора
function formatWithCaret(inputEl){
    const start = inputEl.selectionStart ?? inputEl.value.length;
    const old = inputEl.value;
    const digitsBefore = old.slice(0, start).replace(/[^\d]/g,'').length;

    const n = sanitizeNumber(old);
    if (!Number.isFinite(n)) return;

    const formatted = Math.round(n).toLocaleString('ru-RU');
    inputEl.value = formatted;

    let pos = 0, digitsSeen = 0;
    while (pos < formatted.length && digitsSeen < digitsBefore){
        if (/\d/.test(formatted[pos])) digitsSeen++;
        pos++;
    }
    inputEl.setSelectionRange(pos, pos);
}

function prettifyOnBlur(inputEl){
    const n = sanitizeNumber(inputEl.value);
    if (!Number.isFinite(n)) return;
    inputEl.value = Math.round(n).toLocaleString('ru-RU');
}

function render(){
    const price = sanitizeNumber(priceEl.value);
    const dpRaw = sanitizeNumber(dpEl.value);
    const years = Number(yearsEl.value);

    if (!Number.isFinite(price) || price <= 0 || !Number.isFinite(years) || years <= 0){
        kLoan.textContent = '—';
        kDP.textContent = '—';
        kMonths.textContent = '—';
        tbody.innerHTML = '<tr><td colspan="5" style="color: rgba(255,255,255,.65);">Проверьте ввод.</td></tr>';
        tableHint.textContent = '';
        return;
    }

    const dp = Math.max(0, Math.min(Number.isFinite(dpRaw) ? dpRaw : 0, price));
    const months = Math.round(years * 12);
    const loan = Math.max(0, price - dp);

    kLoan.textContent = money(loan);
    kDP.textContent = money(dp);
    kMonths.textContent = months.toLocaleString('ru-RU');

    const rows = PROGRAMS.map(p => {
        const m = annuity(loan, p.rate, months);
        const total = m * months;
        const overpay = total - loan;
        return { ...p, m, total, overpay };
    }).sort((a,b) => a.m - b.m);

    tbody.innerHTML = rows.map(p => `
        <tr class="${p.id==='dv' ? 'highlight-dv' : ''}">
          <td>${p.name}</td>
          <td>${percent(p.rate)}</td>
          <td>${money(p.m)}</td>
          <td>${money(p.overpay)}</td>
          <td>${money(p.total)}</td>
        </tr>
      `).join('');

    const minM = Math.min(...rows.map(r => r.m));
    const maxM = Math.max(...rows.map(r => r.m));
    tableHint.textContent = `Разница между минимальным и максимальным платежом: ${money(maxM - minM)} в месяц.`;
}

if(calc){
    applyBtn.addEventListener('click', () => {
        render();
        window.location.href = 'https://form.teracorp.ru/';

        // Если нужно отправлять заявку в CRM/на backend:
        // 1) соберите payload
        // const payload = { price: sanitizeNumber(priceEl.value), dp: sanitizeNumber(dpEl.value), years: Number(yearsEl.value) };
        // 2) отправьте fetch(...) на ваш endpoint
        // fetch('/api/lead', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) })
        //   .then(r => r.json()).then(() => alert('Заявка отправлена')).catch(() => alert('Ошибка отправки'));
    });

    resetBtn.addEventListener('click', () => {
        priceEl.value = '8 000 000';
        dpEl.value = '0';
        yearsEl.value = '20';
        render();
    });

// live formatting + rendering
    priceEl.addEventListener('input', () => { if (priceEl.value.trim() !== '') formatWithCaret(priceEl); render(); });
    dpEl.addEventListener('input', () => { if (dpEl.value.trim() !== '') formatWithCaret(dpEl); render(); });
    yearsEl.addEventListener('input', render);

    priceEl.addEventListener('blur', () => { prettifyOnBlur(priceEl); render(); });
    dpEl.addEventListener('blur', () => { prettifyOnBlur(dpEl); render(); });

// init
    prettifyOnBlur(priceEl);
    prettifyOnBlur(dpEl);
    render();
}

// "Подать заявку" — по нажатию просто пересчитываем и можно добавить вашу логику заявки


let body = document.querySelector("body")
let modalTogglers = document.querySelectorAll("[data-modal]")
let modals = document.querySelectorAll(".modal")

modalTogglers.forEach(el => {
    el.onclick = function () {
        let modalId = el.getAttribute("data-modal")
        openModal(modalId)
    }
})

function closeModals() {
    modals.forEach(modal => {
        modal.classList.remove("_active")
        body.classList.remove("fixed-body2")
    })
}

function openModal(modalId) {
    closeModals()
    let modal = document.querySelector(`#${modalId}`)
    let closeButtons = modal.querySelectorAll(`._close-modal`)

    modal.classList.add("_active")
    body.classList.add("fixed-body2")


    closeButtons.forEach(btn => {
        btn.onclick = ()=> {
            modal.classList.remove("_active")
            body.classList.remove("fixed-body2")
        }
    })
}

var getScrollBarSize = (function() {
    var el = window.document.createElement('textarea'), style = {
        'visibility': 'hidden', 'position': 'absolute', 'zIndex': '-2147483647',
        'top': '-1000px', 'left': '-1000px', 'width': '1000px', 'height': '1000px',
        'overflow': 'scroll', 'margin': '0', 'border': '0', 'padding': '0'
    }, support = el.clientWidth !== undefined && el.offsetWidth !== undefined;

    for (var key in style) {
        if (style.hasOwnProperty(key)) {
            el.style[key] = style[key];
        }
    }

    return function() {
        var size = null;
        if (support && window.document.body) {
            window.document.body.appendChild(el);
            size = [el.offsetWidth - el.clientWidth, el.offsetHeight - el.clientHeight];
            window.document.body.removeChild(el);
        }

        document.documentElement.style.setProperty('--scrollWidth', `${size[0]}px`);
        return size;
    };
})();


var localeRu = {
    days: ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'],
    daysShort: ['Вос', 'Пон', 'Вто', 'Сре', 'Чет', 'Пят', 'Суб'],
    daysMin: ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'],
    months: ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'],
    monthsShort: ['Янв', 'Фев', 'Мар', 'Апр', 'Май', 'Июн', 'Июл', 'Авг', 'Сен', 'Окт', 'Ноя', 'Дек'],
    today: 'Сегодня',
    clear: 'Очистить',
    dateFormat: 'dd.MM.yyyy',
    timeFormat: 'HH:mm',
    firstDay: 1
};

window.addEventListener('DOMContentLoaded', () => {
    fix100vh();
    window.addEventListener('resize', () => {
        fix100vh();
        getScrollBarSize()
    })

    getScrollBarSize()

    $('input[type="tel"]').mask('+7 (999) 999-99-99', { autoclear: false }, { placeholder: '+7 (   )    -  -  ' });

    $('.timepicker').timepicker({
        timeFormat: 'H:mm',
        dynamic: false,
        dropdown: true,
        scrollbar: true,
        minTime: '9:00',
        maxTime: '18:00',
        step: 60,
    });

    /**
     * https://stackoverflow.com/questions/2945113/how-to-create-a-new-date-in-javascript-from-a-non-standard-date-format
     * @param input
     * @returns {Date}
     */
    function parseDate(input) {
        if(!input){
            return '';
        }
        const parts = input.match(/(\d+)/g);
        return new Date(parts[2], parts[1]-1, parts[0]);
    }

    let dateInputs = document.querySelectorAll('.date-input')
    console.log(dateInputs)
    dateInputs.forEach(el => {
        new AirDatepicker(el, {
            locale: localeRu,
            autoClose: true,
            toggleSelected: false,
            minDate: '',
            maxDate: parseDate(el.getAttribute('data-max-date')),
            selectedDates: [parseDate(el.value)],
            onSelect: () => {
                $(".date-input").addClass("input-active")
            }
        })
    })
})

function fix100vh() {
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}

//# sourceMappingURL=../sourcemaps/main.min.js.map
